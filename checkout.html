<!-- checkout.html (updated, bilingual + WhatsApp message format) -->
<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Glow On Â· è³¼ç‰©è»Š</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .container{max-width:1100px;margin:0 auto;padding:16px}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{padding:12px;border-bottom:1px solid #e5e7eb;text-align:left;vertical-align:middle}
    th{background:#f9fafb}
    td img{width:60px;height:60px;object-fit:contain;border:1px solid #eee;border-radius:8px;background:#fff}
    .qty-input{width:70px;padding:6px;text-align:center;border:1px solid #e5e7eb;border-radius:8px}
    .total{text-align:right;font-weight:800;font-size:18px;margin-top:20px}
    .empty{padding:30px;text-align:center;color:#666}
    .btn{padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px;cursor:pointer;background:#fff}
    .btn.primary{background:#111;color:#fff;border-color:#111}
    .toolrow{display:flex;gap:10px;justify-content:flex-end;margin-top:16px;flex-wrap:wrap}
    .badge{display:inline-flex;min-width:18px;height:18px;padding:0 6px;align-items:center;justify-content:center;background:#111;color:#fff;border-radius:999px;font-size:12px;margin-left:4px}

    /* Header small tweaks (align with site) */
    .site-header .top{display:flex;align-items:center;justify-content:space-between}
    .site-header .left{display:flex;align-items:center;gap:14px}
    .site-header .logo strong{display:none}
    .site-header .logo img{height:26px;width:auto;display:block}
    .site-header .nav{display:flex;gap:14px;flex-wrap:wrap}
    .site-header .nav a{text-decoration:none}
  </style>
</head>
<body>
  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="top">
        <div class="left">
          <a href="index.html" class="logo">
            <img src="Archive/logo.png" alt="Glow On logo">
            <strong data-i18n="brand">Glow On</strong>
          </a>
          <div class="nav">
            <a href="index.html" data-i18n="nav_home">é¦–é </a>
            <a href="preorder.html" data-route="preorder" data-i18n="nav_preorder">ç²¾é¸é è³¼</a>
            <a href="instock.html"  data-route="instock"  data-i18n="nav_instock">ç¾è²¨å°ˆå€</a>
            <a href="buyagent.html" data-route="service"  data-i18n="nav_service">æ¾³æ´²ä»£è³¼æœå‹™</a>
          </div>
        </div>

        <div class="actions">
          <a class="btn icon whatsapp" 
             href="https://wa.me/85297436663" 
             target="_blank" 
             rel="noopener" 
             title="WhatsApp" 
             aria-label="WhatsApp">
            <img src="Archive/whats.png" alt="WhatsApp" style="height:24px;width:24px;">
          </a>
          <!-- æœç´¢å…¥å£é¢„ç•™åˆ° search.html -->
          <a class="btn icon search" href="search.html" title="Search" aria-label="Search">ğŸ”</a>
          <!-- æ— ç™»å½•æŒ‰é’® -->
          <a class="btn icon cart" href="checkout.html" title="Cart" aria-label="Cart">ğŸ›’ <span id="cartBadge" class="badge">0</span></a>

          <!-- è¯­è¨€åˆ‡æ¢ -->
          <div class="lang">
            <button id="langBtn" class="lang-btn" type="button" aria-haspopup="menu" aria-expanded="false">
              <span aria-hidden="true">ğŸŒ</span>
              <span id="langLabel">ç¹é«”ä¸­æ–‡</span>
              <span class="caret" aria-hidden="true">â–¾</span>
            </button>
            <div class="lang-menu" id="langMenu" role="menu" hidden>
              <button role="menuitem" data-lc="zh-HK">ç¹é«”ä¸­æ–‡</button>
              <button role="menuitem" data-lc="en">English</button>
            </div>
          </div>

          <!-- æ›´å¤šæŒ‰é’®ï¼ˆæ‰‹æœºç«¯ï¼‰ -->
          <button class="btn icon" id="moreBtn" aria-haspopup="menu" aria-expanded="false" title="æ›´å¤š">â‹¯</button>
          <div class="more-menu" id="moreMenu" hidden>
            <a class="item" href="https://wa.me/85297436663" target="_blank" rel="noopener">
              <img src="Archive/whats.png" alt="WhatsApp" style="height:18px;width:18px;vertical-align:middle;"> WhatsApp
            </a>
            <a class="item" href="search.html" id="moreSearch">ğŸ” Search</a>
            <a class="item" href="checkout.html">ğŸ›’ Cart</a>
            <div class="sep"></div>
            <button class="item" type="button" data-set-lc="zh-HK">ç¹é«”ä¸­æ–‡</button>
            <button class="item" type="button" data-set-lc="en">English</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main class="container">
    <h1 id="title">ğŸ›’ è³¼ç‰©è»Š</h1>

    <div id="cart-container"></div>
    <div class="total" id="cart-total"></div>

    <div class="toolrow">
      <a class="btn" id="btn-continue" href="index.html">ç¹¼çºŒè³¼ç‰©</a>
      <button class="btn" id="clearBtn">æ¸…ç©ºè³¼ç‰©è»Š</button>
      <button class="btn primary" id="checkoutBtn">å»çµç®—ï¼ˆWhatsAppï¼‰</button>
    </div>
  </main>

  <footer class="site-footer">
    <div class="container footer-box">
      <div class="copy">2025 Â© Glow On HK. All Rights Reserved.</div>
    </div>
  </footer>

  <script src="site.js"></script>
  <script>
    const CART_KEY='glowon-cart';
    const WHATSAPP_NUMBER = '85297436663';

    function currentLocale(){
      try{
        if (typeof getLocale === 'function'){
          const lc = getLocale();
          if (lc === 'en' || lc === 'zh-HK') return lc;
        }
      }catch(e){}
      const docLang = (document.documentElement.lang || '').toLowerCase();
      return docLang.startsWith('en') ? 'en' : 'zh-HK';
    }

    const getCart=()=>{ try{ return JSON.parse(localStorage.getItem(CART_KEY))||[] }catch{ return [] } };
    const setCart=(c)=> localStorage.setItem(CART_KEY, JSON.stringify(c));

    function updateBadge(){
      const el=document.getElementById('cartBadge');
      if(!el) return;
      el.textContent = getCart().reduce((s,x)=>s+Number(x.qty||0),0);
    }

    function priceToNumber(priceText){
      // "HK$430" -> 430
      const n = parseFloat(String(priceText||'').replace(/[^0-9.]/g,''));
      return isNaN(n)?0:n;
    }

    function t(key){
      const lc = currentLocale();
      const zh = {
        title: 'ğŸ›’ è³¼ç‰©è»Š',
        th_item: 'å•†å“',
        th_name: 'åç¨±',
        th_price: 'å–®åƒ¹',
        th_qty: 'æ•¸é‡',
        th_sub: 'å°è¨ˆ',
        th_action: '',
        empty: 'è³¼ç‰©è»Šæ˜¯ç©ºçš„',
        total_prefix: 'ç¸½è¨ˆï¼šHK$',
        continue: 'ç¹¼çºŒè³¼ç‰©',
        clear: 'æ¸…ç©ºè³¼ç‰©è»Š',
        checkout: 'å»çµç®—ï¼ˆWhatsAppï¼‰',
      };
      const en = {
        title: 'ğŸ›’ Cart',
        th_item: 'Item',
        th_name: 'Name',
        th_price: 'Unit Price',
        th_qty: 'Qty',
        th_sub: 'Subtotal',
        th_action: '',
        empty: 'Your cart is empty',
        total_prefix: 'Total: HK$',
        continue: 'Continue Shopping',
        clear: 'Clear Cart',
        checkout: 'Checkout (WhatsApp)',
      };
      return (lc==='en'?en:zh)[key];
    }

    function renderCart(){
      const cart = getCart();
      const container = document.getElementById('cart-container');
      const totalEl = document.getElementById('cart-total');

      // å¤´éƒ¨æ ‡é¢˜ + æŒ‰é’® i18n
      document.getElementById('title').textContent = t('title');
      document.getElementById('btn-continue').textContent = t('continue');
      document.getElementById('clearBtn').textContent = t('clear');
      document.getElementById('checkoutBtn').textContent = t('checkout');

      if(cart.length===0){
        container.innerHTML = `<div class="empty">${t('empty')}</div>`;
        totalEl.textContent='';
        updateBadge();
        return;
      }

      let rows = cart.map((item,i)=>{
        const unit = priceToNumber(item.price);
        const subtotal = unit * (item.qty||1);
        const safeTitle = (item.title||'').replace(/</g,'&lt;').replace(/>/g,'&gt;');
        return `
        <tr>
          <td><img src="${item.img}" alt="${safeTitle}" onerror="this.src='Archive/placeholder.png'"></td>
          <td>${safeTitle}</td>
          <td>${item.price}</td>
          <td>
            <input type="number" class="qty-input" min="1" value="${item.qty||1}" 
                   onchange="updateQty(${i}, this.value)">
          </td>
          <td>HK$${subtotal.toFixed(2)}</td>
          <td><button class="btn" onclick="removeItem(${i})">Ã—</button></td>
        </tr>`;
      }).join('');

      container.innerHTML = `
        <table>
          <thead>
            <tr>
              <th>${t('th_item')}</th>
              <th>${t('th_name')}</th>
              <th>${t('th_price')}</th>
              <th>${t('th_qty')}</th>
              <th>${t('th_sub')}</th>
              <th>${t('th_action')}</th>
            </tr>
          </thead>
          <tbody>${rows}</tbody>
        </table>
      `;

      const total = cart.reduce((s,item)=> s + priceToNumber(item.price) * (item.qty||1), 0);
      const lc = currentLocale();
      document.getElementById('cart-total').textContent = (lc==='en' ? 'Total: HK$' : 'ç¸½è¨ˆï¼šHK$') + total.toFixed(2);
      updateBadge();
    }

    window.updateQty = function(index, value){
      let cart = getCart();
      cart[index].qty = Math.max(1, parseInt(value)||1);
      setCart(cart);
      renderCart();
    }

    window.removeItem = function(index){
      let cart = getCart();
      cart.splice(index,1);
      setCart(cart);
      renderCart();
    }

    document.getElementById('clearBtn').onclick = ()=>{
      const lc = currentLocale();
      const msg = lc==='en' ? 'Clear all items in cart?' : 'ç¢ºå®šè¦æ¸…ç©ºè³¼ç‰©è»Šå—ï¼Ÿ';
      if(confirm(msg)){
        setCart([]);
        renderCart();
      }
    };

    // WhatsApp ä¸‹å•ï¼šæŒ‰è¯­è¨€ç”Ÿæˆæ¶ˆæ¯
    document.getElementById('checkoutBtn').onclick = ()=>{
      const cart = getCart();
      if(cart.length===0){ 
        alert(currentLocale()==='en' ? 'Your cart is empty' : 'è³¼ç‰©è»Šæ˜¯ç©ºçš„'); 
        return; 
      }
      const lc = currentLocale();
      const total = cart.reduce((s,item)=> s + priceToNumber(item.price) * (item.qty||1), 0);

      let lines = [];
      if (lc === 'en'){
        // EN template
        lines.push('Glow On Website Order');
        lines.push('');
        cart.forEach((item, i)=>{
          const unit = priceToNumber(item.price);
          lines.push(`${i+1}. ${item.title}  x${item.qty||1}`);
          lines.push(`Unit price: HK$${unit.toFixed(2)}`);
        });
        lines.push('');
        lines.push(`Total: HK$${total.toFixed(2)}`);
        lines.push('');
        lines.push('Please confirm the items and let me know payment and delivery arrangements. Thanks!');
      } else {
        // ZH-HK templateï¼ˆæŒ‰ä½ æä¾›çš„æ ¼å¼ï¼‰
        lines.push('Glow On ç¶²ç«™è¨‚å–®');
        lines.push('');
        cart.forEach((item, i)=>{
          const unit = priceToNumber(item.price);
          lines.push(`${i+1}. ${item.title}  x${item.qty||1}`);
          lines.push(`å–®åƒ¹ï¼šHK$${unit.toFixed(2)}`);
        });
        lines.push('');
        lines.push(`ç¸½æ•¸ï¼šHK$${total.toFixed(2)}`);
        lines.push('');
        lines.push('éº»ç…©ç¢ºèªä¸‹è²¨å“ï¼ŒåŒåŸ‹è©±æˆ‘çŸ¥ä»˜æ¬¾åŒé€è²¨å®‰æ’ï¼Œå””è©²ï½');
      }

      const text = encodeURIComponent(lines.join('\n'));
      const url  = `https://wa.me/${WHATSAPP_NUMBER}?text=${text}`;
      window.open(url, '_blank');
    };

    function renderLocaleChrome(){
      const lc = currentLocale();
      document.documentElement.lang = lc;

      // é¡µé¢æ ‡é¢˜
      document.title = (lc==='en' ? 'Glow On Â· Cart' : 'Glow On Â· è³¼ç‰©è»Š');

      // é¡¶éƒ¨â€œé¦–é /Homepageâ€
      document.querySelectorAll('[data-i18n="nav_home"]').forEach(el=>{
        el.textContent = (lc === 'en' ? 'Homepage' : 'é¦–é ');
      });
    }

    // åˆå§‹åŒ–
    renderLocaleChrome();
    renderCart();
    window.addEventListener('locale-changed', ()=>{
      renderLocaleChrome();
      renderCart();
    });
  </script>
</body>
</html>