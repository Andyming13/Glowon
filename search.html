<!-- search.html -->
<!DOCTYPE html>
<html lang="zh-HK">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Glow On Â· æœç´¢</title>
  <link rel="stylesheet" href="styles.css"/>
  <style>
    .site-header .top { display:flex; align-items:center; justify-content:space-between; }
    .site-header .left { display:flex; align-items:center; gap:14px; }
    .site-header .logo strong { display:none; }
    .site-header .logo img { height:26px; width:auto; display:block; }
    .site-header .nav { display:flex; gap:14px; flex-wrap:wrap; }
    .site-header .nav a { text-decoration:none; }
    /* æœç´¢æ¡ */
    .search-bar{display:flex;gap:8px;align-items:center;margin:10px 0 14px}
    .search-input{flex:1;min-width:160px;padding:10px 12px;border:1px solid #e5e7eb;border-radius:10px}
    .seg{
      display:flex;gap:6px;background:#f9fafb;border:1px solid #e5e7eb;border-radius:10px;padding:4px
    }
    .seg button{padding:8px 10px;border:0;background:transparent;border-radius:8px;cursor:pointer}
    .seg button[aria-pressed="true"]{background:#111;color:#fff}
    .btn{padding:10px 14px;border:1px solid #e5e7eb;border-radius:10px;background:#fff;cursor:pointer}
    .muted{color:#6b7280}
    /* ç»“æœç½‘æ ¼ï¼šéµå¾ªä½ ç«™çš„å¡ç‰‡æ ·å¼ */
    .grid{ display:grid; grid-template-columns:repeat(4,1fr); gap:16px; }
    @media (max-width:920px){ .grid{ grid-template-columns:repeat(2,1fr); } }
    /* é¡µè„šè‹±æ–‡è¡Œé»˜è®¤éšè—ï¼Œè¯­è¨€åˆ‡æ¢æ—¶æ˜¾ç¤º */
    .foot-row.en{display:none}
  </style>
</head>
<body data-page="search">
  <!-- Header -->
  <header class="site-header">
    <div class="container">
      <nav class="top">
        <div class="left">
          <a href="index.html" class="logo">
            <img src="Archive/logo.png" alt="Glow On logo">
            <strong data-i18n="brand">Glow On</strong>
          </a>
          <div class="nav">
            <a href="index.html" data-i18n="nav_home">é¦–é </a>
            <a href="preorder.html" data-route="preorder" data-i18n="nav_preorder">ç²¾é¸é è³¼</a>
            <a href="instock.html"  data-route="instock"  data-i18n="nav_instock">ç¾è²¨å°ˆå€</a>
            <a href="buyagent.html" data-route="service"  data-i18n="nav_service">æ¾³æ´²ä»£è³¼æœå‹™</a>
          </div>
        </div>

        <div class="actions">
          <a class="btn icon whatsapp" 
             href="https://wa.me/85297436663" 
             target="_blank" 
             rel="noopener" 
             title="WhatsApp" 
             aria-label="WhatsApp">
            <img src="Archive/whats.png" alt="WhatsApp" style="height:24px;width:24px;">
          </a>
          <!-- å½“å‰é¡µå°±æ˜¯æœç´¢é¡µ -->
          <a class="btn icon search" href="search.html" title="Search" aria-label="Search">ğŸ”</a>
          <!-- ç§»é™¤ç™»å½•æŒ‰é’® -->
          <a class="btn icon cart" href="checkout.html" title="Cart" aria-label="Cart">ğŸ›’</a>

          <!-- è¯­è¨€åˆ‡æ¢ -->
          <div class="lang">
            <button id="langBtn" class="lang-btn" type="button" aria-haspopup="menu" aria-expanded="false">
              <span aria-hidden="true">ğŸŒ</span>
              <span id="langLabel">ç¹é«”ä¸­æ–‡</span>
              <span class="caret" aria-hidden="true">â–¾</span>
            </button>
            <div class="lang-menu" id="langMenu" role="menu" hidden>
              <button role="menuitem" data-lc="zh-HK">ç¹é«”ä¸­æ–‡</button>
              <button role="menuitem" data-lc="en">English</button>
            </div>
          </div>

          <!-- æ›´å¤šæŒ‰é’®ï¼ˆæ‰‹æœºç«¯ï¼‰ -->
          <button class="btn icon" id="moreBtn" aria-haspopup="menu" aria-expanded="false" title="æ›´å¤š">â‹¯</button>
          <div class="more-menu" id="moreMenu" hidden>
            <a class="item" href="https://wa.me/85297436663" target="_blank" rel="noopener">
              <img src="Archive/whats.png" alt="WhatsApp" style="height:18px;width:18px;vertical-align:middle;"> WhatsApp
            </a>
            <a class="item" href="search.html" id="moreSearch">ğŸ” Search</a>
            <!-- æ—  Login -->
            <a class="item" href="checkout.html">ğŸ›’ Cart</a>
            <div class="sep"></div>
            <button class="item" type="button" data-set-lc="zh-HK">ç¹é«”ä¸­æ–‡</button>
            <button class="item" type="button" data-set-lc="en">English</button>
          </div>
        </div>
      </nav>
    </div>
  </header>

  <main>
    <div class="container">
      <h1 id="pageTitle">æœå°‹å•†å“</h1>

      <!-- æœç´¢æ¡ -->
      <div class="search-bar" role="search">
        <input id="q" class="search-input" type="search" autocomplete="off" />
        <div class="seg" role="tablist" aria-label="category">
          <button type="button" class="seg-btn" data-cat="all"     aria-pressed="true"  id="catAll">å…¨éƒ¨</button>
          <button type="button" class="seg-btn" data-cat="preorder" aria-pressed="false" id="catPre">é è³¼</button>
          <button type="button" class="seg-btn" data-cat="instock"  aria-pressed="false" id="catIn">ç¾è²¨</button>
        </div>
        <button id="btnGo" class="btn">æœç´¢</button>
      </div>

      <div id="hint" class="muted"></div>
      <div id="results" class="grid" style="margin-top:12px"></div>
    </div>
  </main>

  <!-- Footerï¼ˆéšè¯­è¨€åˆ‡æ¢ï¼‰ -->
  <footer class="site-footer">
    <div class="container footer-box">
      <nav class="foot-row zh">
        <a href="terms.html"><b>æ¢æ¬¾åŠç´°å‰‡</b></a>
        <a href="privacy.html"><b>ç§éš±æ”¿ç­–</b></a>
        <a href="returns.html"><b>é€€æ›è²¨æ”¿ç­–</b></a>
        <a href="process.html"><b>è³¼è²·æµç¨‹</b></a>
        <a href="payment.html"><b>ä»˜æ¬¾æ–¹å¼</b></a>
        <a href="contact.html"><b>è¯çµ¡æˆ‘å€‘</b></a>
      </nav>
      <nav class="foot-row en">
        <a href="terms.html"><b>Terms &amp; Conditions</b></a>
        <a href="privacy.html"><b>Privacy Policy</b></a>
        <a href="returns.html"><b>Return &amp; Exchange Policy</b></a>
        <a href="process.html"><b>Shopping Process</b></a>
        <a href="payment.html"><b>Payment Methods</b></a>
        <a href="contact.html"><b>Contact Us</b></a>
      </nav>
      <div class="copy">2025 Â© Glow On HK. <span data-i18n="rights">All Rights Reserved.</span></div>
    </div>
  </footer>

  <script src="site.js"></script>
  <script>
    /* === é…ç½®ç‰ˆæœ¬å·ï¼ˆä¸å…¶å®ƒé¡µä¸€è‡´ï¼‰ === */
    const DATA_VERSION = '2025-10-18-01';

    /* === è¯­è¨€å·¥å…· === */
    function currentLocale(){
      try {
        if (typeof getLocale === 'function'){
          const lc = getLocale();
          if (lc === 'en' || lc === 'zh-HK') return lc;
        }
      } catch(e){}
      const docLang = (document.documentElement.lang || '').toLowerCase();
      return docLang.startsWith('en') ? 'en' : 'zh-HK';
    }
    function applyI18n(){
      const lc = currentLocale();
      document.documentElement.lang = lc;

      // é¡¶éƒ¨â€œé¦–é â€ â†’ Homepage
      document.querySelectorAll('[data-i18n="nav_home"]').forEach(el=>{
        el.textContent = (lc === 'en' ? 'Homepage' : 'é¦–é ');
      });

      // æ–‡æ¡ˆ
      const t = {
        'zh-HK': {
          title: 'æœå°‹å•†å“',
          ph: 'è¼¸å…¥é—œéµå­—ï¼ˆä¾‹å¦‚ï¼šè† åŸè›‹ç™½ã€ç‰™è†â€¦ï¼‰',
          btn: 'æœç´¢',
          all: 'å…¨éƒ¨', pre: 'é è³¼', in: 'ç¾è²¨',
          empty: 'æœªæ‰¾åˆ°ç›¸é—œå•†å“ï¼Œè©¦è©¦å…¶ä»–é—œéµå­—ï½',
          hint: 'å¯è¼¸å…¥å•†å“é—œéµå­—ï¼Œä¸¦æŒ‰åˆ†é¡ç¯©é¸'
        },
        'en': {
          title: 'Search Products',
          ph: 'Type keywords (e.g. collagen, toothpasteâ€¦)',
          btn: 'Search',
          all: 'All', pre: 'Pre-Order', in: 'In-Stock',
          empty: 'No matching items. Try another keyword.',
          hint: 'Type keywords and filter by category'
        }
      }[lc];

      document.getElementById('pageTitle').textContent = t.title;
      document.getElementById('q').placeholder = t.ph;
      document.getElementById('btnGo').textContent = t.btn;
      document.getElementById('catAll').textContent = t.all;
      document.getElementById('catPre').textContent = t.pre;
      document.getElementById('catIn').textContent  = t.in;
      document.getElementById('hint').textContent   = t.hint;

      // é¡µè„šä¸­è‹±è¡Œ
      const zhRow = document.querySelector('.foot-row.zh');
      const enRow = document.querySelector('.foot-row.en');
      if (zhRow && enRow){
        if (lc === 'en'){ zhRow.style.display='none'; enRow.style.display='flex'; }
        else { zhRow.style.display='flex'; enRow.style.display='none'; }
      }
    }

    /* === æ•°æ®åŠ è½½ï¼ˆåªåŠ è½½ä¸€æ¬¡ï¼‰ === */
    async function loadProductsOnce(){
      if (window.__PRODUCTS_LOADED__) return;
      const res = await fetch('/products.json?v=' + DATA_VERSION, { cache: 'no-store' });
      if (!res.ok) throw new Error('Failed to load products.json: ' + res.status);
      const data = await res.json();
      window.__PRODUCTS_VERSION__ = data.version || DATA_VERSION;
      window.__PRODUCTS__ = Array.isArray(data) ? data : (data.items || []);
      window.__PRODUCTS_LOADED__ = true;
    }

    /* === ç®€å•è¯„åˆ†åŒ¹é…ï¼šåœ¨ä¸­/è‹±æ ‡é¢˜ä¸æè¿°ä¸­æœç´¢ === */
    function scoreItem(p, q, lc){
      if (!q) return 1; // æ²¡å…³é”®è¯æ—¶å…¨éƒ¨å‘½ä¸­
      const hay = [
        String(p.title_zh || ''), String(p.title_en || ''),
        String(p.desc_zh || ''),  String(p.desc_en || '')
      ].join(' ').toLowerCase();
      const tokens = q.toLowerCase().trim().split(/\s+/).filter(Boolean);
      if (tokens.length === 0) return 1;
      let hit = 0;
      tokens.forEach(t => { if (hay.includes(t)) hit++; });
      if (!hit) return 0;
      // è¯­è¨€ä¼˜å…ˆï¼šå¦‚æœå½“å‰è¯­è¨€æ ‡é¢˜å‘½ä¸­ï¼ŒåŠ ç‚¹åˆ†
      const titleNow = (lc === 'en' ? (p.title_en || p.title_zh || '') : (p.title_zh || p.title_en || '')).toLowerCase();
      let bonus = tokens.some(t => titleNow.includes(t)) ? 0.5 : 0;
      return hit + bonus;
    }

    /* === æ‰§è¡Œæœç´¢å¹¶æ¸²æŸ“ === */
    function doSearch(){
      if (typeof renderCardsInto !== 'function'){
        console.warn('renderCardsInto æœªå®šä¹‰ï¼Œè¯·æ£€æŸ¥ site.js æ˜¯å¦åŠ è½½');
        return;
      }
      const lc  = currentLocale();
      const q   = document.getElementById('q').value || '';
      const cat = document.querySelector('.seg-btn[aria-pressed="true"]')?.dataset.cat || 'all';

      const list = (window.__PRODUCTS__ || []).slice();

      // å…ˆç­›é€‰åˆ†ç±»
      const filtered = list.filter(p => {
        if (cat === 'all') return true;
        return String(p.category).toLowerCase() === cat;
      });

      // è¯„åˆ†å¹¶æ’åºï¼ˆé«˜åˆ†åœ¨å‰ï¼‰
      const scored = filtered
        .map(p => ({ p, s: scoreItem(p, q, lc) }))
        .filter(x => x.s > 0 || q.trim() === '')
        .sort((a,b) => b.s - a.s)
        .map(x => x.p);

      // æ¸²æŸ“
      const mount = '#results';
      const beforeCount = scored.length;
      // renderCardsInto ä¼šæŒ‰åˆ—è¡¨é¡ºåºæ¸²æŸ“ï¼Œæˆ‘ä»¬åŒ…è£…ä¸€ä¸ªç™½åå•è¿‡æ»¤å™¨
      const allow = new Set(scored.map(p => String(p.id)));
      renderCardsInto(mount, p => allow.has(String(p.id)));

      // ç©ºæ€æç¤º
      const has = document.querySelector(mount)?.children?.length > 0;
      const msg = (lc === 'en') ? 'No matching items. Try another keyword.' : 'æœªæ‰¾åˆ°ç›¸é—œå•†å“ï¼Œè©¦è©¦å…¶ä»–é—œéµå­—ï½';
      document.getElementById('hint').textContent = has ? '' : msg;

      // æ›´æ–° URLï¼ˆä¾¿äºåˆ†äº«ï¼‰
      const params = new URLSearchParams(location.search);
      if (q) params.set('q', q); else params.delete('q');
      if (cat !== 'all') params.set('cat', cat); else params.delete('cat');
      const next = location.pathname + (params.toString() ? ('?' + params.toString()) : '');
      history.replaceState(null, '', next);
    }

    /* === äº¤äº’ç»‘å®š === */
    function bindUI(){
      const input = document.getElementById('q');
      const btn   = document.getElementById('btnGo');
      const segs  = document.querySelectorAll('.seg-btn');

      // å›è½¦æœç´¢ & ç‚¹å‡»æœç´¢
      input.addEventListener('keydown', (e)=>{ if(e.key==='Enter'){ doSearch(); }});
      btn.addEventListener('click', doSearch);

      // åˆ†ç±»åˆ‡æ¢
      segs.forEach(b=>{
        b.addEventListener('click', ()=>{
          segs.forEach(x=>x.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed','true');
          doSearch();
        });
      });
    }

    /* === ä» URL åˆå§‹åŒ– q/cat === */
    function initFromURL(){
      const params = new URLSearchParams(location.search);
      const q   = params.get('q')   || '';
      const cat = (params.get('cat') || 'all').toLowerCase();
      document.getElementById('q').value = q;
      const target = document.querySelector(`.seg-btn[data-cat="${cat}"]`);
      if (target){
        document.querySelectorAll('.seg-btn').forEach(x=>x.setAttribute('aria-pressed','false'));
        target.setAttribute('aria-pressed','true');
      }
    }

    /* === é¡µé¢åˆå§‹åŒ– === */
    function boot(){
      applyI18n();
      initFromURL();
      bindUI();
      if (window.__PRODUCTS_LOADED__) return doSearch();
      loadProductsOnce().then(doSearch).catch(console.error);
    }

    document.addEventListener('DOMContentLoaded', boot);
    window.addEventListener('locale-changed', ()=>{
      applyI18n();
      doSearch();
    });
  </script>
</body>
</html>